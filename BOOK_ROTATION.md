# 书籍循环规则说明

## 📚 智能循环机制

应用实现了智能的书籍循环机制，确保：
1. ✅ 每本书在14天内不会重复出现
2. ✅ 支持任意数量的书籍（不固定为100本）
3. ✅ 可以动态添加新书到 `books.json`
4. ✅ 当所有书籍都使用过后，会智能循环使用

---

## 🔄 工作原理

### 14天冷却期规则

- **规则**：每本书在使用后，在接下来的14天内不会被再次选择
- **目的**：确保用户不会在短时间内看到重复的书籍
- **实现**：系统会检查历史记录，过滤掉在目标日期前后14天内使用过的书籍

### 确定性选择

- **同一日期总是选择同一本书**：使用基于日期的确定性算法
- **好处**：用户可以分享特定日期的书籍，链接总是显示相同的内容

### 回退机制

- **情况**：如果所有书籍都在冷却期内（理论上不会发生，因为14天冷却期意味着最多只有 `books.length - 14` 本书在冷却中）
- **处理**：系统会回退到使用所有书籍，确保应用始终有书籍可选

---

## 📖 添加新书籍

### 如何添加

1. **编辑 `data/books.json`**
2. **添加新书籍条目**：
   ```json
   {
     "id": 101,
     "title_cn": "新书名",
     "title_en": "New Book Title",
     "author": "作者名"
   }
   ```
3. **重启服务器**（或等待自动重启）

### 注意事项

- ✅ **ID 必须唯一**：确保新书的 `id` 不与现有书籍重复
- ✅ **格式一致**：保持与现有条目相同的格式
- ✅ **自动适应**：代码会自动检测新书籍数量，无需修改代码

### 示例

假设你现在有100本书，想添加第101本：

```json
[
  ... (现有100本书) ...,
  {
    "id": 101,
    "title_cn": "新书",
    "title_en": "New Book",
    "author": "新作者"
  }
]
```

重启后，系统会自动：
- 识别有101本书
- 在循环中使用这101本书
- 应用14天冷却期规则

---

## 🔍 循环示例

### 场景1：100本书的情况

- **第1-100天**：每本书使用一次
- **第101天**：选择第1本书（如果它不在冷却期内）
- **第102天**：选择第2本书（如果它不在冷却期内）
- **以此类推**

### 场景2：添加新书后（101本书）

- **第1-101天**：每本书使用一次
- **第102天**：选择第1本书（如果它不在冷却期内）
- **第103天**：选择第2本书（如果它不在冷却期内）
- **以此类推**

### 场景3：冷却期的影响

假设：
- 第1天使用了书籍A
- 第2-14天使用了其他书籍
- 第15天：书籍A可以再次使用（因为距离第1天已经14天）

---

## 🛠️ 技术实现

### `getBookForDate` 函数

```javascript
// 1. 检查该日期是否已有选择（保持确定性）
// 2. 计算从启动日期开始的天数
// 3. 获取14天内使用过的书籍ID
// 4. 过滤掉冷却期内的书籍
// 5. 使用确定性算法从候选书籍中选择
// 6. 记录选择到历史
```

### `pickNewBookId` 函数

```javascript
// 1. 获取最近14天内使用过的书籍ID
// 2. 过滤掉冷却期内的书籍
// 3. 如果所有书都在冷却期，使用所有书籍（回退）
// 4. 从候选书籍中随机选择
// 5. 记录选择到历史
```

---

## ✅ 验证

### 检查书籍数量

服务器启动时会显示：
```
✓ Loaded 100 books from database
```

添加新书后，重启服务器会显示：
```
✓ Loaded 101 books from database
```

### 测试循环

1. **查看历史记录**：检查 `data/history.json`
2. **验证冷却期**：确认同一本书不会在14天内重复出现
3. **测试确定性**：同一日期总是返回同一本书

---

## 🎯 最佳实践

### 添加新书时

1. ✅ 使用递增的ID（101, 102, 103...）
2. ✅ 保持JSON格式正确
3. ✅ 重启服务器使更改生效
4. ✅ 检查日志确认新书已加载

### 维护时

1. ✅ 定期检查 `history.json` 的大小（如果太大可以清理旧记录）
2. ✅ 监控日志中的警告信息
3. ✅ 确保 `books.json` 格式正确

---

## ⚠️ 注意事项

### ID 冲突

- **问题**：如果新书的ID与现有书籍重复
- **结果**：可能导致选择错误
- **解决**：确保每个ID唯一

### 历史记录过大

- **问题**：`history.json` 文件可能随时间增长
- **影响**：理论上不影响功能，但可能影响性能
- **建议**：如果文件过大，可以考虑清理旧记录（保留最近90天的记录）

### 冷却期计算

- **当前实现**：基于日期差异计算（`Math.abs(entryDaysSinceStart - daysSinceStart) < 14`）
- **含义**：目标日期前后14天内的书籍都会被排除
- **效果**：确保用户不会在短时间内看到重复书籍

---

## 📊 性能考虑

### 书籍数量

- ✅ **支持任意数量**：代码使用 `books.length` 动态获取
- ✅ **无硬编码限制**：不固定为100本
- ✅ **高效过滤**：使用 `Set` 数据结构快速查找

### 历史记录

- ✅ **高效查询**：使用 `Set` 和 `filter` 快速过滤
- ✅ **确定性选择**：使用模运算快速定位书籍
- ✅ **最小化写入**：只在需要时写入历史记录

---

## 🔄 未来改进

可能的增强功能：
- [ ] 支持自定义冷却期（不仅仅是14天）
- [ ] 支持书籍分类和优先级
- [ ] 支持手动指定某天的书籍
- [ ] 支持书籍使用统计和分析

---

**总结**：系统已经完全支持动态书籍数量，你可以随时添加新书到 `books.json`，系统会自动适应并应用14天冷却期规则。

