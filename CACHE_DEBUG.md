# 缓存问题调试指南

## 问题：内容生成很慢，看起来没有使用缓存

### 可能的原因

1. **Railway 缓存没有持久化**
   - Railway 容器默认是临时的，每次重启/部署都会清空文件
   - 需要配置 Volume 来持久化 `data/` 目录

2. **预生成没有执行**
   - 服务器启动时预生成可能失败
   - 检查 Railway 日志确认预生成是否执行

3. **缓存文件路径问题**
   - 确认缓存文件保存在正确的位置
   - 检查 `data/cache.json` 是否存在

## 调试步骤

### 1. 检查 Railway Volume 配置

在 Railway 项目中：
1. 进入项目设置
2. 找到 "Volumes" 或 "Persistent Storage"
3. 创建一个 Volume，挂载到 `/app/data`
4. 确保 `data/` 目录被持久化

### 2. 检查日志

查看 Railway 日志，应该看到：
- `🚀 启动智能预生成检查...`
- `📚 优先生成今天的内容: ...`
- `✅ 今天的内容已生成并批准...`
- `📝 缓存已保存...`
- `✅ 缓存验证成功...`

### 3. 检查缓存文件

如果可能，检查 `data/cache.json` 文件：
- 文件是否存在
- 是否包含已批准的内容
- 内容格式是否正确

### 4. 检查 API 请求日志

当用户请求摘要时，日志应该显示：
- `🔍 [ensureSummary] 检查书籍 X 的缓存状态...`
- `✅ [ensureSummary] 从缓存返回书籍 X 的内容（已批准）` - 如果从缓存读取
- `❌ [ensureSummary] 书籍 X 不在缓存中，需要生成` - 如果需要生成

如果看到"不在缓存中"，说明缓存没有正确保存或持久化。

## 解决方案

### 方案 1: 配置 Railway Volume（推荐）

1. 在 Railway 项目设置中创建 Volume
2. 挂载到 `/app/data`
3. 重启服务

### 方案 2: 使用外部存储

如果 Railway Volume 不可用，可以考虑：
- 使用数据库（如 PostgreSQL）存储缓存
- 使用 Redis 存储缓存
- 使用云存储（如 S3）存储缓存文件

### 方案 3: 检查预生成执行

确保预生成在服务器启动时正确执行：
- 检查日志确认预生成启动
- 如果失败，查看错误信息
- 可能需要增加延迟时间或修复错误

## 临时解决方案

如果缓存问题持续存在，可以：
1. 手动触发预生成（通过管理界面）
2. 等待预生成完成后再访问
3. 或者接受首次访问需要等待的情况

