# 生产环境问题处理指南

## 📋 功能概览

应用已添加以下生产环境功能：

1. ✅ **维护模式** - 可以临时关闭应用进行维护
2. ✅ **增强的健康检查** - 监控缓存和API状态
3. ✅ **友好的错误消息** - 用户看到清晰的错误提示
4. ✅ **自动重试机制** - 网络错误时自动重试
5. ✅ **全局错误处理** - 捕获未处理的异常
6. ✅ **用户反馈渠道** - 页脚提供联系链接

---

## 🛠️ 如何使用

### 1. 启用维护模式

当需要临时关闭应用进行维护时：

**在 Railway 中设置环境变量：**
```
MAINTENANCE_MODE=true
```

**效果：**
- 所有用户请求（除了 `/health` 和 `/admin.html`）会返回 503 错误
- 用户看到友好的维护消息："系统维护中，请稍后再试"
- Admin 界面仍然可以访问，方便你管理

**关闭维护模式：**
```
MAINTENANCE_MODE=false
```
或删除该环境变量

---

### 2. 检查应用健康状态

**访问健康检查端点：**
```
GET /health
```

**返回信息包括：**
- `status`: "ok" 或 "degraded"
- `maintenance`: 是否处于维护模式
- `cache.size`: 缓存条目数量
- `cache.approved`: 已批准的内容数量
- `api.configured`: API密钥是否配置
- `startDate`: 应用启动日期

**示例响应：**
```json
{
  "status": "ok",
  "service": "book-journey",
  "timestamp": "2026-01-01T10:00:00.000Z",
  "maintenance": false,
  "cache": {
    "size": 15,
    "approved": 15,
    "healthy": true
  },
  "api": {
    "configured": true
  },
  "startDate": "2026-01-01"
}
```

---

### 3. 查看错误日志

**在 Railway 中查看日志：**
```bash
railway logs --tail 100
```

**查找错误：**
```bash
railway logs | grep -i error
```

**常见错误模式：**
- `❌ Error in ensureSummary` - 摘要生成失败
- `❌ DeepSeek API error` - API调用失败
- `❌ Uncaught Exception` - 未捕获的异常
- `❌ Unhandled Rejection` - 未处理的Promise拒绝

---

### 4. 用户遇到问题时的处理流程

#### 步骤 1: 确认问题
- 访问应用，尝试复现问题
- 查看 Railway 日志：`railway logs --tail 50`

#### 步骤 2: 判断严重性

**严重（所有用户受影响）：**
- 立即启用维护模式
- 在社交媒体/邮件通知用户
- 开始修复

**中等（部分用户受影响）：**
- 记录问题详情
- 准备修复方案
- 监控错误日志

**轻微（个别用户）：**
- 记录问题
- 后续修复

#### 步骤 3: 修复问题

**如何寻求帮助：**
1. 切换到 agent mode
2. 提供以下信息：
   ```
   问题描述：用户点击深度按钮时出现 500 错误
   
   错误日志：
   [从 Railway 日志中复制]
   
   时间：2026-01-01 10:00 AM
   影响范围：所有用户
   复现步骤：点击任意深度按钮
   ```
3. 我会帮你分析和修复

---

## 🔍 错误类型和处理

### 网络错误
- **用户看到**："网络连接异常，请检查网络后重试"
- **自动重试**：最多 3 次，每次间隔 5 秒
- **后端处理**：记录错误日志

### 服务器错误 (500)
- **用户看到**："内容生成中，请稍候片刻后重试"
- **自动重试**：最多 3 次
- **后端处理**：记录详细错误信息

### 维护模式 (503)
- **用户看到**："系统维护中，请稍后再试"
- **自动重试**：不重试
- **后端处理**：返回维护信息

### 超时错误
- **用户看到**："请求超时，正在重试..."
- **自动重试**：最多 3 次，每次间隔 3 秒

---

## 📧 用户反馈

用户可以通过页脚的"遇到问题？联系我们"链接发送邮件。

**建议：**
- 将 `your-email@example.com` 替换为你的实际邮箱
- 在 `public/index.html` 中更新邮箱地址

---

## 🚨 紧急情况处理

### 场景 1: API 密钥失效
1. 立即启用维护模式
2. 更新 Railway 环境变量 `DEEPSEEK_API_KEY`
3. 关闭维护模式

### 场景 2: 缓存损坏
1. 查看错误日志确认问题
2. 使用 admin 界面清除问题缓存
3. 或运行：`railway run npm run clear-cache clear <bookId>`

### 场景 3: 服务器崩溃
1. Railway 会自动重启
2. 查看日志确认重启原因
3. 如果是代码问题，回滚到上一个版本

---

## 📊 监控建议

### 定期检查
- **每天**：查看 `/health` 端点状态
- **每周**：检查错误日志模式
- **每月**：审查缓存使用情况

### 关键指标
- 缓存命中率（从日志中观察）
- API 调用成功率
- 用户错误报告数量

---

## 🔄 回滚策略

如果新版本出现问题：

1. **在 Railway 中：**
   - 进入项目设置
   - 找到 "Deployments" 或 "History"
   - 选择上一个稳定版本
   - 点击 "Redeploy"

2. **或使用 Git：**
   ```bash
   git revert HEAD
   git push
   ```

---

## 📝 问题报告模板

向 AI 助手求助时，使用以下模板：

```
问题描述：[简要描述问题]

错误日志：
[从 Railway 日志中复制相关错误]

时间：[问题发生时间]
影响范围：[所有用户/部分用户/个别用户]
复现步骤：
1. [步骤1]
2. [步骤2]
3. [步骤3]

当前状态：
- 维护模式：[是/否]
- 健康检查：[/health 端点返回]
- 最近更改：[如有]
```

---

## ✅ 检查清单

发布前确认：
- [ ] 健康检查端点正常工作
- [ ] 错误处理已测试
- [ ] 维护模式可以正常启用/关闭
- [ ] 用户反馈邮箱已更新
- [ ] 日志记录正常

问题发生时：
- [ ] 查看健康检查状态
- [ ] 检查错误日志
- [ ] 判断问题严重性
- [ ] 决定是否启用维护模式
- [ ] 通知用户（如需要）
- [ ] 开始修复或寻求帮助

---

## 🎯 快速命令参考

```bash
# 查看日志
railway logs --tail 100

# 查看错误
railway logs | grep -i error

# 检查健康状态
curl https://your-app.railway.app/health

# 清除缓存（特定书籍）
railway run npm run clear-cache clear <bookId>

# 清除所有缓存
railway run npm run clear-cache
```

---

**记住：** 当用户遇到问题时，最重要的是快速响应和清晰的沟通。使用维护模式可以给用户明确的预期，而友好的错误消息可以减少用户的困惑。

